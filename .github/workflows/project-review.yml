name: 'Check project review'

on:
  workflow_call:

env:
  RUN_DETAIL: "\n\n:octocat: @${{ github.actor }} see [run id ${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details."

jobs:
  check_request:
    name: 'Check Request'
    runs-on: 'ubuntu-latest'
    if: ${{ github.event.review.state == 'approved' && github.event.review.user.login == 'sjengle' }}

    outputs:


    steps:
      - name: 'Startup'
        uses: 'actions/github-script@v6'
        with:
          script: |
            console.log(context);
            let error_message = undefined;

            github.rest.issues.createComment({
              owner: context.payload.organization.login,
              repo: context.payload.repository.name,
              issue_number: context.payload.pull_request.number,
              body: `:robot: The GitHub Actions bot is now processing this pull request...${ process.env.RUN_DETAIL}`
            });

  update_labels:
    name: 'Update Labels'
    runs-on: 'ubuntu-latest'
    needs: ['check_request']

    steps:
      - name: 'Code'
        uses: 'actions/github-script@v6'
        if: ${{ contains(github.event.review.body, 'Resubmit for Code Review') }}
        with:
          script: |
            const label = 'review-resubmit';
            core.exportVariable('label', label);
            console.log('label:', label);

      - name: 'Quick'
        uses: 'actions/github-script@v6'
        if: ${{ contains(github.event.review.body, 'Resubmit for Quick Review') }}
        with:
          script: |
            const label = 'review-resubmit-quick';
            core.exportVariable('label', label);
            console.log('label:', label);

      - name: 'Pass'
        uses: 'actions/github-script@v6'
        if: ${{ contains(github.event.review.body, 'Pass') }}
        with:
          script: |
            const label = 'review-passed';
            core.exportVariable('label', label);
            console.log('label:', label);

      - name: 'Update'
        uses: 'actions/github-script@v6'
        if: ${{ !failure() }}
        with:
          script: |
            github.rest.issues.addLabels({
              owner: context.payload.organization.login,
              repo: context.payload.repository.name,
              issue_number: context.payload.pull_request.number,
              labels: [process.env.label]
            });

# TODO Check review
# When a pull request review is submitted, check the status. If the status was
# approved by the instructor, then indicate the request is being processed.
# Otherwise, do nothing.
#
# To process the request, check the review comment. There are three possible
# results:
#
# 1. Resubmit for another normal review -or- quick review. Apply the appropriate
#    labels and respond with instructions for how to request the next appointment.
#    Include what range of dates the next appointment should occur.
#
# 2. Conditional pass or pass. Apply the appropriate labels and respond with
#    instructions for how to prepare the final release. Include when the final
#    release should be created by to avoid late penalties.
#
# 3. Other. This could be associated with a cancelled review for some reason. No
#    labels should be applied.
